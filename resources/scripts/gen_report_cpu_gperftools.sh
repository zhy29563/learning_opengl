#!/bin/bash

########################################################################################################################
# 目录变量
########################################################################################################################
SCT_DIR=$(cd $(dirname $0) && pwd)       # scripts
RES_DIR=$(dirname ${SCT_DIR})            # reources
PJT_DIR=$(dirname ${RES_DIR})            # repo
BLT_DIR=${PJT_DIR}/build_cpu_gperftools  # build

########################################################################################################################
# 依赖库编译环境变量
########################################################################################################################
ENVS_ROOT=${HOME}/.envs
LIBS_PATH=x86_64-linux-gnu-v9.4.0
LIBS_ROOT=${ENVS_ROOT}/libs/${LIBS_PATH}

########################################################################################################################
# 编译
########################################################################################################################

rm -rf "${BLT_DIR}"
mkdir -p "${BLT_DIR}" && cd "${BLT_DIR}"
cmake .. -G"Unix Makefiles" -DENABLE_TEST_CPU_GPERFTOOLS=ON
make -j16
########################################################################################################################
# 运行测试程序并生成报告
########################################################################################################################
env CPUPROFILE_FREQUENCY=1000 ${BLT_DIR}/apps/app_add/app_add
${LIBS_ROOT}/libgperftools-2.10/bin/pprof --pdf       ${BLT_DIR}/apps/app_add/app_add ./app_add.prof > app_add.pdf
${LIBS_ROOT}/libgperftools-2.10/bin/pprof --callgrind ${BLT_DIR}/apps/app_add/app_add ./app_add.prof > app_add.callgrind

########################################################################################################################
# 显示报告
########################################################################################################################
if [[ $1 == "show" ]]; then
  kcachegrind app_add.callgrind
fi
